<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão MAWB/HOUSE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 450px;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .form-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .houses-container {
            border: 2px dashed #ddd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .house-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .house-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .house-title {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .data-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .data-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .data-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .data-entry input {
            flex: 1;
        }

        .data-entry button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .tag {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .input-error {
            border-color: #dc3545 !important;
        }

        .input-valid {
            border-color: #28a745 !important;
        }

        .input-filled {
            background-color: #f8f9fa !important;
            border-color: #28a745 !important;
            color: #6c757d !important;
        }

        .input-disabled {
            background-color: #e9ecef !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .btn-disabled {
            background: #6c757d !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .success-indicator {
            display: inline-flex;
            align-items: center;
            color: #28a745;
            font-size: 14px;
            margin-top: 8px;
            font-weight: 500;
        }

        .success-indicator::before {
            content: "✓";
            margin-right: 6px;
            font-weight: bold;
            font-size: 16px;
        }

        .value-display {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }

        .remove-value-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            padding: 0;
            margin-left: 10px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .remove-value-btn:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .edit-value-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            padding: 0;
            margin-left: 10px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .edit-value-btn:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        /* Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .toggle-container label {
            margin-left: 10px;
            font-weight: 500;
        }

        .house-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .house-list-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .house-list-item:last-child {
            border-bottom: none;
        }

        .house-list-item:hover {
            background-color: #f1f3f5;
        }

        .house-list-item.selected {
            background-color: #667eea;
            color: white;
            font-weight: bold;
        }

        .data-entry-wrapper {
            margin-top: 10px;
        }

        .toggles-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            align-items: center;
        }

        .special-data-section {
            margin-top: 15px;
        }

        .remove-house-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="form-section">
                <h2>Configuração</h2>

                <div class="form-group">
                    <label for="spreadsheet">Selecionar Planilha:</label>
                    <select id="spreadsheet" required>
                        <option value="">Selecione uma planilha...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mawb">MAWB:</label>
                    <input type="text" id="mawb" placeholder="Digite o MAWB (11 dígitos)" required maxlength="12">
                    <div id="mawbError" class="error-message"></div>
                </div>
            </div>

            <div class="form-section">
                <h2>HOUSES</h2>
                <div class="form-group">
                    <label for="newHouses">Adicionar um ou mais HOUSEs:</label>
                    <textarea id="newHouses" placeholder="Cole uma lista de HOUSEs aqui, um por linha." rows="5" onpaste="handlePaste(event, 'house')"></textarea>
                    <div id="houseError" class="error-message"></div>
                    <button type="button" class="btn" onclick="addHouses()" style="margin-top: 10px;">Adicionar</button>
                    <div id="housesList" class="houses-container">
                        <div class="empty-state">
                            <p>Nenhum HOUSE adicionado</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <button type="button" class="btn" onclick="saveData()" style="width: 100%; font-size: 18px; padding: 15px;">
                    Salvar Dados
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>Sistema de Gestão MAWB/HOUSE</h1>
                <p>Gerencie suas entregas de forma eficiente</p>
            </div>

            <div id="alerts"></div>

            <div id="dataSection" class="form-section" style="display: none;">
                <h2>Dados por HOUSE</h2>
                <div id="housesData"></div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Salvando dados...</p>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplicação
        let houses = [];
        let houseData = {};
        let selectedHouse = null;

        // Tipos de dados disponíveis
        const dataTypes = [
            { key: 'refs', label: 'Referências', placeholder: 'Digite uma referência' },
            { key: 'consignees', label: 'Consignatários', placeholder: 'Digite um consignatário' },
            { key: 'entregas', label: 'Entregas', placeholder: 'Digite uma entrega' },
            { key: 'dtas', label: 'DTAs', placeholder: 'Digite uma DTA' },
            { key: 'previsoes', label: 'Previsões', placeholder: 'Digite uma previsão' },
            { key: 'responsaveis', label: 'Responsáveis', placeholder: 'Digite um responsável' },
        ];

        const specialDataTypes = [
            { key: 'observacoes', label: 'Observações', placeholder: 'Digite uma observação' }
        ];

        // Funções de validação
        function validateMAWB(mawb) {
            let normalized = mawb.trim();

            if (!normalized) {
                return { valid: false, message: 'MAWB é obrigatório' };
            }

            // Remove o hífen para validação
            normalized = normalized.replace(/-/g, '');

            if (!/^\d+$/.test(normalized)) {
                return { valid: false, message: 'MAWB deve conter apenas números' };
            }

            if (normalized.length !== 11) {
                return { valid: false, message: 'MAWB deve ter exatamente 11 dígitos' };
            }

            return { valid: true };
        }

        function validateHOUSE(house) {
            const normalized = house.trim();

            if (!normalized) {
                return { valid: false, message: 'HOUSE é obrigatório' };
            }

            // Length check is now handled by the stripping logic in addHouses
            return { valid: true };
        }

        function showFieldError(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(errorId);

            field.classList.add('input-error');
            field.classList.remove('input-valid');
            errorDiv.innerHTML = message; // Use innerHTML to render <br> tags
            errorDiv.style.display = 'block';
        }

        function clearFieldError(fieldId, errorId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(errorId);

            field.classList.remove('input-error');
            field.classList.add('input-valid');
            errorDiv.style.display = 'none';
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadSpreadsheets();

            // Validação em tempo real para MAWB
            document.getElementById('mawb').addEventListener('input', function(e) {
                const validation = validateMAWB(e.target.value);
                if (!validation.valid && e.target.value.trim()) {
                    showFieldError('mawb', 'mawbError', validation.message);
                } else if (validation.valid) {
                    clearFieldError('mawb', 'mawbError');
                } else {
                    // Campo vazio - limpa erro mas não mostra válido
                    const field = document.getElementById('mawb');
                    const errorDiv = document.getElementById('mawbError');
                    field.classList.remove('input-error', 'input-valid');
                    errorDiv.style.display = 'none';
                }
            });

            // Validação e auto-ajuste em tempo real para HOUSE
            document.getElementById('newHouse').addEventListener('input', function(e) {
                const input = e.target;
                const originalValue = input.value.trim().toUpperCase();
                const trimInfoDiv = document.getElementById('houseTrimInfo');

                if (originalValue.length > 11) {
                    const toRemoveCount = originalValue.length - 11;
                    const removedPart = originalValue.substring(0, toRemoveCount);
                    const keptPart = originalValue.substring(toRemoveCount);

                    // Atualiza o valor do input
                    input.value = keptPart;

                    // Mostra a mensagem informativa
                    trimInfoDiv.textContent = `Original: ${originalValue}, Removido: "${removedPart}"`;
                    trimInfoDiv.style.display = 'block';
                } else {
                    trimInfoDiv.style.display = 'none';
                }

                // Validação normal
                const validation = validateHOUSE(input.value);
                if (!validation.valid && input.value.trim()) {
                    showFieldError('newHouse', 'houseError', validation.message);
                } else if (validation.valid) {
                    clearFieldError('newHouse', 'houseError');
                } else {
                    const field = document.getElementById('newHouse');
                    const errorDiv = document.getElementById('houseError');
                    field.classList.remove('input-error', 'input-valid');
                    errorDiv.style.display = 'none';
                }
            });

            // Enter key para adicionar house
            document.getElementById('newHouse').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addHouse();
                }
            });
        });

        // Carrega lista de planilhas disponíveis
        function loadSpreadsheets() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.ok) {
                        const select = document.getElementById('spreadsheet');
                        result.payload.forEach(sheet => {
                            const option = document.createElement('option');
                            option.value = sheet.id;
                            option.textContent = sheet.name;
                            select.appendChild(option);
                        });
                    } else {
                        showAlert('Erro ao carregar planilhas: ' + result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showAlert('Erro ao carregar planilhas: ' + error.message, 'error');
                })
                .getSpreadsheets();
        }

        function toggleExport(house) {
            const isChecked = document.getElementById(`exportToggle_${house}`).checked;
            const entregas = houseData[house]['entregas'] || [];

            if (isChecked) {
                // Add 'EXPORTAÇÃO' if it's not already there
                if (!entregas.includes('EXPORTAÇÃO')) {
                    entregas.push('EXPORTAÇÃO');
                }
            } else {
                // Remove 'EXPORTAÇÃO' but keep other values
                const index = entregas.indexOf('EXPORTAÇÃO');
                if (index > -1) {
                    entregas.splice(index, 1);
                }
            }
            houseData[house]['entregas'] = entregas;
            updateDataSection();
        }

        function clearHouses() {
            houses = [];
            houseData = {};
            selectedHouse = null;
            updateHousesDisplay();
            updateDataSection();
        }

        function toggleFridge(house) {
            const isChecked = document.getElementById(`fridgeToggle_${house}`).checked;
            if (isChecked) {
                houseData[house]['observacoes'] = ['FRI']; // Default value
            } else {
                const fridgeCodes = ["FRI", "FRO", "COL", "ERT", "CRT"];
                const currentObs = houseData[house]?.observacoes?.[0] || '';
                if (fridgeCodes.includes(currentObs)) {
                    houseData[house]['observacoes'] = [];
                }
            }
            updateDataSection();
        }

        function setFridgeType(house) {
            const value = document.getElementById(`fridgeType_${house}`).value;
            houseData[house]['observacoes'] = value ? [value] : [];
            updateDataSection();
        }

        // Adiciona um novo HOUSE
        function addHouse() {
            const input = document.getElementById('newHouses');
            addHouses();
        }

        function addHouses() {
            const input = document.getElementById('newHouses');
            const houseValues = input.value.trim().split('\n').filter(h => h.trim() !== '');
            const errorDiv = document.getElementById('houseError');

            let warnings = [];
            let errors = [];
            let housesToAdd = [];
            const potentialHouses = new Set();

            // Step 1: Process all inputs and collect errors, warnings, and valid houses
            for (const originalValue of houseValues) {
                let house = originalValue.trim().toUpperCase();

                if (house.length > 11) {
                    const originalForWarning = house;
                    house = house.substring(house.length - 11);
                    warnings.push(`Original: "${originalForWarning}", cortado para: "${house}"`);
                }

                const validation = validateHOUSE(house);
                if (!validation.valid) {
                    errors.push(`"${originalValue}" inválido: ${validation.message}`);
                    continue;
                }

                if (houses.includes(house) || potentialHouses.has(house)) {
                    errors.push(`"${originalValue}" resulta em um HOUSE duplicado: "${house}"`);
                    continue;
                }

                potentialHouses.add(house);
                housesToAdd.push(house);
            }

            // Step 2: Display errors OR warnings. Errors take precedence.
            if (errors.length > 0) {
                showFieldError('newHouses', 'houseError', errors.join('<br>'));
                return; // Stop execution
            }

            if (warnings.length > 0) {
                errorDiv.innerHTML = `<strong>Avisos:</strong><br>${warnings.join('<br>')}`;
                errorDiv.style.color = '#666';
                errorDiv.style.display = 'block';
                input.classList.remove('input-error');
                input.classList.add('input-valid');
            } else {
                // Only clear if there were no errors and no warnings
                clearFieldError('newHouses', 'houseError');
            }

            // Step 3: If we are here, there were no errors. Add the houses and update UI.
            if (housesToAdd.length > 0) {
                housesToAdd.forEach(houseName => {
                    houses.push(houseName);
                    houseData[houseName] = {};
                    dataTypes.forEach(type => houseData[houseName][type.key] = []);
                    specialDataTypes.forEach(type => houseData[houseName][type.key] = []);
                });

                input.value = '';
                updateHousesDisplay();
                if (housesToAdd.length === 1) {
                    selectHouse(houses[houses.length - 1]);
                }
            }
        }


        // Remove um HOUSE
        function removeHouse(house) {
            const index = houses.indexOf(house);
            if (index > -1) {
                houses.splice(index, 1);
                delete houseData[house];
                if (selectedHouse === house) {
                    selectedHouse = null;
                }
                updateHousesDisplay();
                updateDataSection();
            }
        }

        function editHouseName(index) {
            const span = document.getElementById(`house-name-${index}`);
            const currentName = span.textContent;
            span.innerHTML = `<input type="text" id="edit-house-${index}" value="${currentName}"
                                     onblur="saveHouseName(${index})"
                                     onkeypress="handleHouseNameKey(event, ${index})">`;
            document.getElementById(`edit-house-${index}`).focus();
        }

        function handleHouseNameKey(event, index) {
            if (event.key === 'Enter') {
                saveHouseName(index);
            } else if (event.key === 'Escape') {
                updateHousesDisplay(); // Revert changes
            }
        }

        function saveHouseName(index) {
            const input = document.getElementById(`edit-house-${index}`);
            const newName = input.value.trim().toUpperCase();
            const oldName = houses[index];

            if (newName === oldName) {
                updateHousesDisplay();
                return;
            }

            const validation = validateHOUSE(newName);
            if (!validation.valid) {
                showAlert(`Nome de HOUSE inválido: ${validation.message}`, 'error');
                updateHousesDisplay();
                return;
            }

            if (houses.includes(newName)) {
                showAlert(`HOUSE "${newName}" já existe.`, 'error');
                updateHousesDisplay();
                return;
            }

            // Update state
            houses[index] = newName;
            houseData[newName] = houseData[oldName];
            delete houseData[oldName];
            if (selectedHouse === oldName) {
                selectedHouse = newName;
            }

            updateHousesDisplay();
        }

        // Seleciona um HOUSE para edição
        function selectHouse(house) {
            selectedHouse = house;
            updateHousesDisplay(); // Para atualizar a classe 'selected'
            updateDataSection();
        }

        // Atualiza a exibição da lista de HOUSES
        function updateHousesDisplay() {
            const container = document.getElementById('housesList');
            if (houses.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Nenhum HOUSE adicionado</p></div>`;
                return;
            }

            let html = `
                <ul class="house-list">
                    ${houses.map((house, index) => `
                        <li class="house-list-item ${selectedHouse === house ? 'selected' : ''}"
                            id="house-list-item-${house}"
                            onclick="selectHouse('${house}')"
                            ondblclick="editHouseName(${index})">
                            <span id="house-name-${index}">${house}</span>
                            <button class="remove-house-btn" onclick="event.stopPropagation(); removeHouse('${house}');">×</button>
                        </li>
                    `).join('')}
                </ul>
            `;

            if (houses.length > 0) {
                html += `<button type="button" class="btn btn-secondary" style="margin-top: 10px;" onclick="clearHouses()">Limpar</button>`;
            }

            container.innerHTML = html;
        }

        function updateDataSection() {
            const section = document.getElementById('dataSection');
            const container = document.getElementById('housesData');

            if (!selectedHouse) {
                section.style.display = 'block';
                container.innerHTML = `
            <div class="empty-state">
                <h2>Selecione um HOUSE</h2>
                <p>Clique em um HOUSE na lista à esquerda para ver ou editar seus dados.</p>
            </div>
        `;
                return;
            }

            const house = selectedHouse;
            section.style.display = 'block';
            container.innerHTML = `
        <div class="house-item-header">
            <h2 class="house-title">Dados para ${house}</h2>
        </div>

        <div class="toggles-section">
            <div class="toggle-container">
                <label class="switch">
                    <input type="checkbox" id="exportToggle_${house}" onchange="toggleExport('${house}')">
                    <span class="slider"></span>
                </label>
                <label for="exportToggle_${house}">Exportação</label>
            </div>
            <div class="toggle-container">
                <label class="switch">
                    <input type="checkbox" id="fridgeToggle_${house}" onchange="toggleFridge('${house}')">
                    <span class="slider"></span>
                </label>
                <label for="fridgeToggle_${house}">Carga de Geladeira</label>
            </div>
            <div id="fridgeOptions_${house}" style="display: none; margin-top: 10px;">
                <label for="fridgeType_${house}">Tipo:</label>
                <select id="fridgeType_${house}" onchange="setFridgeType('${house}')">
                    <option value="">Selecione...</option>
                    <option value="FRI">FRI</option>
                    <option value="FRO">FRO</option>
                    <option value="COL">COL</option>
                    <option value="ERT">ERT</option>
                    <option value="CRT">CRT</option>
                </select>
            </div>
        </div>
        <div class="data-grid">
            ${dataTypes.map(type => renderDataField(type, house)).join('')}
        </div>
        <div class="special-data-section">
            ${specialDataTypes.map(type => renderDataField(type, house)).join('')}
        </div>
    `;
            syncToggles(house);
        }

        function renderDataField(type, house) {
            const hasValue = houseData[house] && houseData[house][type.key] && houseData[house][type.key].length > 0;
            const value = hasValue ? houseData[house][type.key][0] : '';
            const inputId = `${type.key}_${house}`;

            return `
                <div class="data-section">
                    <h3>${type.label}</h3>
                    <div class="data-entry-wrapper" id="wrapper-${inputId}">
                        ${hasValue ? `
                            <div class="value-display" onclick="editDataEntry('${type.key}', '${house}')">
                                <span>${value}</span>
                                <button class="edit-value-btn">✏️</button>
                            </div>
                        ` : `
                            <div class="data-entry">
                                <input type="text" id="${inputId}" placeholder="${type.placeholder}" onkeypress="handleDataEntry(event, '${type.key}', '${house}')" onpaste="handlePaste(event, '${type.key}', '${house}')">
                                <button type="button" class="btn btn-secondary" onclick="addDataEntry('${type.key}', '${house}')">Adicionar</button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Manipula entrada de dados com Enter
        function handleDataEntry(event, dataType, house) {
            if (event.key === 'Enter') {
                addDataEntry(dataType, house);
            }
        }

        function handlePaste(event, dataType, house) {
            event.preventDefault();
            const pastedText = (event.clipboardData || window.clipboardData).getData('text');
            if (dataType === 'house') {
                const input = document.getElementById('newHouses');
                input.value += pastedText;
                addHouses();
            } else {
                const input = document.getElementById(`${dataType}_${house}`);
                input.value = pastedText;
                addDataEntry(dataType, house);
            }
        }

        function editDataEntry(dataType, house) {
            const value = houseData[house][dataType][0];
            const inputId = `${dataType}_${house}`;
            const wrapper = document.getElementById(`wrapper-${inputId}`);

            wrapper.innerHTML = `
                <div class="data-entry">
                    <input type="text" id="${inputId}" value="${value}">
                    <button type="button" class="btn" onclick="saveDataEntry('${dataType}', '${house}')">Salvar</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEdit('${dataType}', '${house}')">Cancelar</button>
                </div>
            `;
            document.getElementById(inputId).focus();
        }

        // Adiciona entrada de dados (apenas um valor por input)
        function addDataEntry(dataType, house) {
            const input = document.getElementById(`${dataType}_${house}`);
            const value = input.value.trim();
            if (value) {
                houseData[house][dataType] = [value];
                updateDataSection();
            }
        }

        function saveDataEntry(dataType, house) {
            const input = document.getElementById(`${dataType}_${house}`);
            const value = input.value.trim();
            if (value) {
                houseData[house][dataType] = [value];
            } else {
                houseData[house][dataType] = [];
            }
            updateDataSection();
        }

        function cancelEdit(dataType, house) {
            updateDataSection();
        }

        function syncToggles(house) {
            const isExport = houseData[house]?.entregas?.includes('EXPORTAÇÃO') || false;
            document.getElementById(`exportToggle_${house}`).checked = isExport;
            document.getElementById(`wrapper-entregas_${house}`).style.display = isExport ? 'none' : 'block';

            const fridgeCodes = ["FRI", "FRO", "COL", "ERT", "CRT"];
            const currentObs = houseData[house]?.observacoes?.[0] || '';
            const isFridge = fridgeCodes.includes(currentObs);
            document.getElementById(`fridgeToggle_${house}`).checked = isFridge;
            document.getElementById(`fridgeOptions_${house}`).style.display = isFridge ? 'block' : 'none';
            if (isFridge) {
                document.getElementById(`fridgeType_${house}`).value = currentObs;
            }
        }


        // Salva os dados
        async function saveData() {
            const spreadsheetId = document.getElementById('spreadsheet').value;
            const mawb = document.getElementById('mawb').value.trim();

            // Validações
            if (!spreadsheetId) {
                showAlert('Selecione uma planilha', 'error');
                return;
            }

            // Validação do MAWB
            const mawbValidation = validateMAWB(mawb);
            if (!mawbValidation.valid) {
                showFieldError('mawb', 'mawbError', mawbValidation.message);
                showAlert('Corrija os erros antes de salvar', 'error');
                return;
            }

            if (houses.length === 0) {
                showAlert('Adicione pelo menos um HOUSE', 'error');
                return;
            }

            // Prepara payload
            const payload = {
                spreadsheetId,
                mawb,
                houses,
                refs: [],
                consignees: [],
                entregas: [],
                dtas: [],
                previsoes: [],
                responsaveis: [],
                observacoes: []
            };

            // Coleta todos os dados
            houses.forEach(house => {
                dataTypes.forEach(type => {
                    const data = houseData[house][type.key] || [];
                    data.forEach(value => {
                        payload[type.key].push({ house, value });
                    });
                });
            });

            // Mostra loading
            document.getElementById('loading').style.display = 'block';

            try {
                // Chama a função do Google Apps Script
                const result = await google.script.run
                    .withSuccessHandler(handleSaveSuccess)
                    .withFailureHandler(handleSaveError)
                    .saveEntries(payload);

            } catch (error) {
                handleSaveError(error);
            }
        }

        // Manipula sucesso no salvamento
        function handleSaveSuccess(result) {
            document.getElementById('loading').style.display = 'none';

            if (result.ok) {
                const { inserted, updated, removed_duplicates } = result.payload;
                showAlert(`Dados salvos com sucesso! Inseridos: ${inserted}, Atualizados: ${updated}, Duplicatas removidas: ${removed_duplicates}`, 'success');

                // Limpa o formulário
                resetForm();
            } else {
                showAlert(`Erro: ${result.message}${result.detail ? ' - ' + result.detail : ''}`, 'error');
            }
        }

        // Manipula erro no salvamento
        function handleSaveError(error) {
            document.getElementById('loading').style.display = 'none';
            showAlert(`Erro ao salvar: ${error.message || error}`, 'error');
        }

        // Reseta o formulário
        function resetForm() {
            document.getElementById('mawb').value = '';
            houses = [];
            houseData = {};
            updateHousesDisplay();
            updateDataSection();
        }

        // Mostra alertas
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" onclick="this.parentElement.remove()"
                        style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">
                    ×
                </button>
            `;

            alertsContainer.appendChild(alertDiv);

            // Remove automaticamente após 5 segundos
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>