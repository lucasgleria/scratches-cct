<script>
        // Estado da aplicação
        let houses = []; // Array of objects: { id, name }
        let houseData = {}; // Keyed by house.id
        let selectedHouse = null; // Stores the selected house's id
        let houseIdCounter = 0; // To generate unique IDs for houses
        let isEditMode = false;
        let isServicosMode = false;

        // Tipos de dados disponíveis
        const dataTypes = [
            { key: 'refs', label: 'Referências', placeholder: 'Digite uma referência' },
            { key: 'consignees', label: 'Consignatários', placeholder: 'Digite um consignatário' },
            { key: 'entregas', label: 'Entregas', placeholder: 'Digite uma entrega' },
            { key: 'dtas', label: 'DTAs', placeholder: 'Digite uma DTA' },
            { key: 'previsoes', label: 'Previsões', placeholder: 'Digite uma previsão' },
            { key: 'responsaveis', label: 'Responsáveis', placeholder: 'Digite um responsável' },
        ];

        const specialDataTypes = [
            { key: 'observacoes', label: 'Observações', placeholder: 'Digite uma observação' }
        ];

        // Funções de validação
        function validateMAWB(mawb) {
            let normalized = mawb.trim();

            if (!normalized) {
                return { valid: false, message: 'MAWB é obrigatório' };
            }

            // Remove o hífen para validação
            normalized = normalized.replace(/-/g, '');

            if (!/^\d+$/.test(normalized)) {
                return { valid: false, message: 'MAWB deve conter apenas números' };
            }

            if (normalized.length !== 11) {
                return { valid: false, message: 'MAWB deve ter exatamente 11 dígitos' };
            }

            return { valid: true };
        }

        function validateHOUSE(house) {
            const normalized = house.trim();

            if (!normalized) {
                return { valid: false, message: 'HOUSE é obrigatório' };
            }

            // Length check is now handled by the stripping logic in addHouses
            return { valid: true };
        }

        function showFieldError(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(errorId);

            field.classList.add('input-error');
            field.classList.remove('input-valid');
            errorDiv.innerHTML = message; // Use innerHTML to render <br> tags
            errorDiv.style.display = 'block';
        }

        function clearFieldError(fieldId, errorId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(errorId);

            field.classList.remove('input-error');
            field.classList.add('input-valid');
            errorDiv.style.display = 'none';
        }

        // Inicialização
        loadSpreadsheets();

        // Validação em tempo real para MAWB
        document.getElementById('mawb').addEventListener('input', function(e) {
            const validation = validateMAWB(e.target.value);
            if (!validation.valid && e.target.value.trim()) {
                showFieldError('mawb', 'mawbError', validation.message);
            } else if (validation.valid) {
                clearFieldError('mawb', 'mawbError');
            } else {
                // Campo vazio - limpa erro mas não mostra válido
                const field = document.getElementById('mawb');
                const errorDiv = document.getElementById('mawbError');
                field.classList.remove('input-error', 'input-valid');
                errorDiv.style.display = 'none';
            }
        });

        // Carrega lista de planilhas disponíveis
        function loadSpreadsheets() {
            const viewName = document.querySelector('.container').dataset.viewName;
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.ok) {
                        const select = document.getElementById('spreadsheet');
                        // Limpa as opções existentes para evitar duplicatas ao trocar de view
                        select.innerHTML = '<option value="">Selecione uma planilha...</option>';
                        result.payload.forEach(sheet => {
                            const option = document.createElement('option');
                            option.value = sheet.id;
                            option.textContent = sheet.name;
                            select.appendChild(option);
                        });
                    } else {
                        showAlert('Erro ao carregar planilhas: ' + result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showAlert('Erro ao carregar planilhas: ' + error.message, 'error');
                })
                .getSpreadsheets(viewName);
        }


        function clearHouses() {
            houses = [];
            houseData = {};
            selectedHouse = null;
            isEditMode = false; // Garante que o modo de edição seja desativado
            updateHousesDisplay();
            updateDataSection();
        }

        function toggleFridge(houseId) {
            const isChecked = document.getElementById(`fridgeToggle_${houseId}`).checked;
            const fridgeCodes = ["FRI", "FRO", "COL", "ERT", "CRT"];
            let obs = houseData[houseId]?.observacoes || [];

            // Remove all existing fridge codes to avoid duplicates or conflicts
            obs = obs.filter(o => !fridgeCodes.includes(o));

            if (isChecked) {
                obs.push('FRI'); // Add default fridge code
            }

            houseData[houseId].observacoes = obs;
            updateDataSection();
        }

        function setFridgeType(houseId) {
            const value = document.getElementById(`fridgeType_${houseId}`).value;
            const fridgeCodes = ["FRI", "FRO", "COL", "ERT", "CRT"];
            let obs = houseData[houseId]?.observacoes || [];

            // Remove all existing fridge codes
            obs = obs.filter(o => !fridgeCodes.includes(o));

            if (value) {
                obs.push(value); // Add the selected fridge code
            }

            houseData[houseId].observacoes = obs;
            updateDataSection();
        }

        function toggleSimpleObservation(houseId, value, toggleId) {
            const isChecked = document.getElementById(toggleId).checked;
            let obs = houseData[houseId]?.observacoes || [];
            const index = obs.indexOf(value);

            if (isChecked) {
                if (index === -1) {
                    obs.push(value);
                }
            } else {
                if (index > -1) {
                    obs.splice(index, 1);
                }
            }
            houseData[houseId].observacoes = obs;
            updateDataSection();
        }

        // Adiciona um novo HOUSE
        function addHouse() {
            const input = document.getElementById('newHouses');
            addHouses();
        }

        async function addHouses() {
            const input = document.getElementById('newHouses');
            const houseValues = input.value.trim().split('\n').filter(h => h.trim() !== '');
            const errorDiv = document.getElementById('houseError');
            const spreadsheetId = document.getElementById('spreadsheet').value;

            if (!spreadsheetId) {
                showAlert('Por favor, selecione uma planilha primeiro.', 'error');
                return;
            }

            document.getElementById('loading').style.display = 'block';

            let warnings = [];
            let errors = [];
            let housesToAdd = [];
            const potentialHouses = new Set();

            for (const originalValue of houseValues) {
                let house = originalValue.trim().toUpperCase();

                if (house.length > 11) {
                    const originalForWarning = house;
                    house = house.substring(house.length - 11);
                    warnings.push(`Original: "${originalForWarning}", cortado para: "${house}"`);
                }

                const validation = validateHOUSE(house);
                if (!validation.valid) {
                    errors.push(`"${originalValue}" inválido: ${validation.message}`);
                    continue;
                }

                if (houses.some(h => h.name === house) || potentialHouses.has(house)) {
                    errors.push(`"${originalValue}" resulta em um HOUSE duplicado na lista de adição.`);
                    continue;
                }

                try {
                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .checkHouseExists(spreadsheetId, house);
                    });

                    if (result.ok && result.payload) {
                        confirmEdit(house);
                    } else if (result.ok && !result.payload) {
                        potentialHouses.add(house);
                        housesToAdd.push(house);
                    } else {
                        errors.push(result.message || 'Erro desconhecido ao verificar HOUSE.');
                    }
                } catch (error) {
                    errors.push(`Falha na comunicação ao verificar HOUSE "${house}".`);
                }
            }

            document.getElementById('loading').style.display = 'none';
            input.value = '';

            if (errors.length > 0) {
                showFieldError('newHouses', 'houseError', errors.join('<br>'));
            } else if (warnings.length > 0) {
                errorDiv.innerHTML = `<strong>Avisos:</strong><br>${warnings.join('<br>')}`;
                errorDiv.style.color = '#666';
                errorDiv.style.display = 'block';
                input.classList.remove('input-error');
                input.classList.add('input-valid');
            } else {
                clearFieldError('newHouses', 'houseError');
            }

            if (housesToAdd.length > 0) {
                housesToAdd.forEach(houseName => {
                    if (!houses.some(h => h.name === houseName)) {
                        const newId = houseIdCounter++;
                        houses.push({ id: newId, name: houseName });
                        houseData[newId] = {};
                        dataTypes.forEach(type => houseData[newId][type.key] = []);
                        specialDataTypes.forEach(type => houseData[newId][type.key] = []);
                    }
                });
                updateHousesDisplay();
                if (housesToAdd.length === 1) {
                    selectHouse(houses[houses.length - 1].id);
                }
            }
        }

        function confirmEdit(house) {
            const message = `O HOUSE "${house}" já existe na planilha. Deseja carregar os dados existentes para edição?`;
            if (confirm(message)) {
                selectHouseForEditing(house);
            }
        }

        // Remove um HOUSE
        function removeHouse(houseId) {
            const index = houses.findIndex(h => h.id === houseId);
            if (index > -1) {
                houses.splice(index, 1);
                delete houseData[houseId];
                if (selectedHouse === houseId) {
                    selectedHouse = null;
                }
                updateHousesDisplay();
                updateDataSection();
            }
        }

        function editHouseName(houseId) {
            const house = houses.find(h => h.id === houseId);
            if (!house) return;

            const span = document.getElementById(`house-name-${houseId}`);
            if (span) {
                span.innerHTML = `<input type="text" id="edit-house-${houseId}" value="${house.name}"
                                     onblur="saveHouseName(${houseId})"
                                     onkeypress="handleHouseNameKey(event, ${houseId})">`;
                document.getElementById(`edit-house-${houseId}`).focus();
            }
        }

        function handleHouseNameKey(event, houseId) {
            if (event.key === 'Enter') {
                saveHouseName(houseId);
            } else if (event.key === 'Escape') {
                updateHousesDisplay(); // Revert changes
            }
        }

        function saveHouseName(houseId) {
            const input = document.getElementById(`edit-house-${houseId}`);
            if (!input) {
                updateHousesDisplay();
                return;
            }
            const newName = input.value.trim().toUpperCase();
            const house = houses.find(h => h.id === houseId);

            if (!house) return; // Should not happen

            if (newName === house.name) {
                updateHousesDisplay();
                return;
            }

            const validation = validateHOUSE(newName);
            if (!validation.valid) {
                showAlert(`Nome de HOUSE inválido: ${validation.message}`, 'error');
                updateHousesDisplay();
                return;
            }

            if (houses.some(h => h.name === newName && h.id !== houseId)) {
                showAlert(`HOUSE "${newName}" já existe.`, 'error');
                updateHousesDisplay();
                return;
            }

            // Update state
            house.name = newName;
            updateHousesDisplay();
        }

        // Seleciona um HOUSE para edição
        function selectHouse(houseId) {
            // Se já estiver selecionado, não faz nada para permitir a interação (ex: double-click)
            if (selectedHouse === houseId) return;

            // Remove a classe 'selected' do item anteriormente selecionado
            if (selectedHouse !== null) {
                const oldItem = document.getElementById(`house-list-item-${selectedHouse}`);
                if (oldItem) {
                    oldItem.classList.remove('selected');
                }
            }

            selectedHouse = houseId;

            // Adiciona a classe 'selected' ao novo item selecionado
            const newItem = document.getElementById(`house-list-item-${houseId}`);
            if (newItem) {
                newItem.classList.add('selected');
            }

            updateDataSection();
        }

        // Atualiza a exibição da lista de HOUSES
        function updateHousesDisplay() {
            const container = document.getElementById('housesList');
            if (houses.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Nenhum HOUSE adicionado</p></div>`;
                return;
            }

            let html = `
        <ul class="house-list">
            ${houses.map(house => `
                <li class="house-list-item ${selectedHouse === house.id ? 'selected' : ''}"
                    id="house-list-item-${house.id}"
                    onclick="selectHouse(${house.id})"
                    ondblclick="editHouseName(${house.id})">
                    <span id="house-name-${house.id}">${house.name}</span>
                    <button class="remove-house-btn" onclick="event.stopPropagation(); removeHouse(${house.id});">×</button>
                </li>
            `).join('')}
        </ul>
    `;

            if (houses.length > 0) {
                html += `<button type="button" class="btn btn-secondary" style="margin-top: 10px;" onclick="clearHouses()">Limpar</button>`;
            }

            container.innerHTML = html;
        }

        function updateDataSection() {
            const section = document.getElementById('dataSection');
            const container = document.getElementById('housesData');

            if (selectedHouse === null) {
                section.style.display = 'block';
                container.innerHTML = `
            <div class="empty-state">
                <h2>Selecione um HOUSE</h2>
                <p>Clique em um HOUSE na lista à esquerda para ver ou editar seus dados.</p>
            </div>
        `;
                return;
            }
            const house = houses.find(h => h.id === selectedHouse);
            if (!house) {
                selectedHouse = null;
                updateDataSection(); // Re-render with empty state
                return;
            }
            const houseId = house.id;
            const houseName = house.name;

            section.style.display = 'block';
            container.innerHTML = `
        <div class="house-item-header">
            <h2 class="house-title">Dados para ${houseName}</h2>
        </div>

        <div class="toggles-section">
            <div class="toggle-container">
                <label class="switch">
                    <input type="checkbox" id="fridgeToggle_${houseId}" onchange="toggleFridge(${houseId})">
                    <span class="slider"></span>
                </label>
                <label for="fridgeToggle_${houseId}">Carga de Geladeira</label>
            </div>
            <div id="fridgeOptions_${houseId}" style="display: none; margin-top: 10px;">
                <label for="fridgeType_${houseId}">Tipo:</label>
                <select id="fridgeType_${houseId}" onchange="setFridgeType(${houseId})">
                    <option value="">Selecione...</option>
                    <option value="FRI">FRI</option>
                    <option value="FRO">FRO</option>
                    <option value="COL">COL</option>
                    <option value="ERT">ERT</option>
                    <option value="CRT">CRT</option>
                </select>
            </div>
        </div>
        <div class="data-grid">
            ${dataTypes.map(type => renderDataField(type, houseId)).join('')}
        </div>
        <div class="special-data-section">
            ${specialDataTypes.map(type => renderDataField(type, houseId)).join('')}
        </div>
    `;
            syncToggles(houseId);
        }

        function renderDataField(type, houseId) {
            const hasValue = houseData[houseId] && houseData[houseId][type.key] && houseData[houseId][type.key].length > 0;
            const value = hasValue ? houseData[houseId][type.key][0] : '';
            const inputId = `${type.key}_${houseId}`;
            const isDisabled = isServicosMode && type.key !== 'responsaveis';

            // Combobox para Entregas
            if (type.key === 'entregas') {
                const options = ["TRANSPALLET", "WEST", "PASTA", "?"];
                return `
                <div class="data-section">
                    <h3>${type.label}</h3>
                    <div class="data-entry-wrapper" id="wrapper-${inputId}">
                        <div class="data-entry">
                            <select id="${inputId}" onchange="addDataEntry('${type.key}', ${houseId})" ${isDisabled ? 'disabled' : ''}>
                                <option value="">Selecione...</option>
                                ${options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            `;
            }

            return `
                <div class="data-section">
                    <h3>${type.label}</h3>
                    <div class="data-entry-wrapper" id="wrapper-${inputId}">
                        ${hasValue ? `
                            <div class="value-display" onclick="${!isDisabled ? `editDataEntry('${type.key}', ${houseId})` : ''}">
                                <span>${value}</span>
                                ${!isDisabled ? `<button class="edit-value-btn">✏️</button>` : ''}
                            </div>
                        ` : `
                            <div class="data-entry">
                                <input type="text" id="${inputId}" placeholder="${type.placeholder}" onkeypress="handleDataEntry(event, '${type.key}', ${houseId})" onpaste="handlePaste(event, '${type.key}', ${houseId})" onblur="addDataEntry('${type.key}', ${houseId})" ${isDisabled ? 'disabled' : ''}>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Manipula entrada de dados com Enter
        function handleDataEntry(event, dataType, houseId) {
            if (event.key === 'Enter') {
                addDataEntry(dataType, houseId);
            }
        }

        function handlePaste(event, dataType, houseId) {
            event.preventDefault();
            const pastedText = (event.clipboardData || window.clipboardData).getData('text');
            if (dataType === 'house') {
                const input = document.getElementById('newHouses');
                input.value += pastedText;
                addHouses();
            } else {
                const input = document.getElementById(`${dataType}_${houseId}`);
                input.value = pastedText;
                addDataEntry(dataType, houseId);
            }
        }

        function editDataEntry(dataType, houseId) {
            const value = houseData[houseId][dataType][0];
            const inputId = `${dataType}_${houseId}`;
            const wrapper = document.getElementById(`wrapper-${inputId}`);

            wrapper.innerHTML = `
                <div class="data-entry">
                    <input type="text" id="${inputId}" value="${value}" onblur="saveDataEntry('${dataType}', ${houseId})" onkeypress="handleEditKey(event, '${dataType}', ${houseId})">
                </div>
            `;
            document.getElementById(inputId).focus();
        }

        function handleEditKey(event, dataType, houseId) {
            if (event.key === 'Enter') {
                saveDataEntry(dataType, houseId);
            } else if (event.key === 'Escape') {
                cancelEdit(dataType, houseId);
            }
        }

        // Adiciona entrada de dados (apenas um valor por input)
        function addDataEntry(dataType, houseId) {
            const input = document.getElementById(`${dataType}_${houseId}`);
            const value = input.value.trim();
            if (value) {
                houseData[houseId][dataType] = [value];
                updateDataSection();
            }
        }

        function saveDataEntry(dataType, houseId) {
            const input = document.getElementById(`${dataType}_${houseId}`);
            const value = input.value.trim();
            if (value) {
                houseData[houseId][dataType] = [value];
            } else {
                houseData[houseId][dataType] = [];
            }
            updateDataSection();
        }

        function cancelEdit(dataType, houseId) {
            updateDataSection();
        }

        function syncToggles(houseId) {
            const obs = houseData[houseId]?.observacoes || [];
            const fridgeCodes = ["FRI", "FRO", "COL", "ERT", "CRT"];

            // Sincroniza Carga de Geladeira
            const fridgeObs = obs.find(o => fridgeCodes.includes(o));
            const isFridge = !!fridgeObs;
            document.getElementById(`fridgeToggle_${houseId}`).checked = isFridge;
            document.getElementById(`fridgeOptions_${houseId}`).style.display = isFridge ? 'block' : 'none';
            if (isFridge) {
                document.getElementById(`fridgeType_${houseId}`).value = fridgeObs;
            }

            // Sincroniza outros toggles
            // These elements don't seem to exist in the provided HTML, but keeping the logic
            // in case they are dynamically added elsewhere.
            const servicosToggle = document.getElementById(`servicosToggle_${houseId}`);
            if(servicosToggle) servicosToggle.checked = obs.includes('SERVICOS');

            const protestoToggle = document.getElementById(`protestoToggle_${houseId}`);
            if(protestoToggle) protestoToggle.checked = obs.includes('CARTA PROTESTO');

            const ajustesToggle = document.getElementById(`ajustesToggle_${houseId}`);
            if(ajustesToggle) ajustesToggle.checked = obs.includes('AJUSTES');
        }


        // Salva os dados
        async function saveData() {
            const spreadsheetId = document.getElementById('spreadsheet').value;
            const mawb = document.getElementById('mawb').value.trim();

            // Validações
            if (!spreadsheetId) {
                showAlert('Selecione uma planilha', 'error');
                return;
            }

            // Validação do MAWB
            const mawbValidation = validateMAWB(mawb);
            if (!mawbValidation.valid) {
                showFieldError('mawb', 'mawbError', mawbValidation.message);
                showAlert('Corrija os erros antes de salvar', 'error');
                return;
            }

            if (houses.length === 0) {
                showAlert('Adicione pelo menos um HOUSE', 'error');
                return;
            }

            // Prepara payload
            const payload = {
                spreadsheetId,
                mawb,
                houses: houses.map(h => h.name), // Envia apenas os nomes
                isEditMode,
                isServicosMode,
                refs: [],
                consignees: [],
                entregas: [],
                dtas: [],
                previsoes: [],
                responsaveis: [],
                observacoes: []
            };

            // Coleta todos os dados de forma explícita para evitar erros
            houses.forEach(house => {
                const houseId = house.id;
                const houseName = house.name;
                (houseData[houseId].refs || []).forEach(value => payload.refs.push({ house: houseName, value }));
                (houseData[houseId].consignees || []).forEach(value => payload.consignees.push({ house: houseName, value }));
                (houseData[houseId].entregas || []).forEach(value => payload.entregas.push({ house: houseName, value }));
                (houseData[houseId].dtas || []).forEach(value => payload.dtas.push({ house: houseName, value }));
                (houseData[houseId].previsoes || []).forEach(value => payload.previsoes.push({ house: houseName, value }));
                (houseData[houseId].responsaveis || []).forEach(value => payload.responsaveis.push({ house: houseName, value }));
                (houseData[houseId].observacoes || []).forEach(value => payload.observacoes.push({ house: houseName, value }));
            });

            // Mostra loading
            document.getElementById('loading').style.display = 'block';

            try {
                // Chama a função do Google Apps Script
                const result = await google.script.run
                    .withSuccessHandler(handleSaveSuccess)
                    .withFailureHandler(handleSaveError)
                    .saveEntries(payload);

            } catch (error) {
                handleSaveError(error);
            }
        }

        // Manipula sucesso no salvamento
        function handleSaveSuccess(result) {
            document.getElementById('loading').style.display = 'none';

            if (result.ok) {
                const { inserted, updated, removed_duplicates } = result.payload;
                showAlert(`Dados salvos com sucesso! Inseridos: ${inserted}, Atualizados: ${updated}, Duplicatas removidas: ${removed_duplicates}`, 'success');

                // Limpa o formulário
                resetForm();
            } else {
                showAlert(`Erro: ${result.message}${result.detail ? ' - ' + result.detail : ''}`, 'error');
            }
        }

        // Manipula erro no salvamento
        function handleSaveError(error) {
            document.getElementById('loading').style.display = 'none';
            showAlert(`Erro ao salvar: ${error.message || error}`, 'error');
        }

        // Reseta o formulário
        function resetForm() {
            document.getElementById('mawb').value = '';
            houses = [];
            houseData = {};
            selectedHouse = null;
            isEditMode = false;
            isServicosMode = false;
            updateHousesDisplay();
            updateDataSection();
            document.getElementById('dataSection').style.display = 'none';
        }

        // Mostra alertas
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" onclick="this.parentElement.remove()"
                        style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">
                    ×
                </button>
            `;

            alertsContainer.appendChild(alertDiv);

            // Remove automaticamente após 5 segundos
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Funções do Modo Editor
        function openEditorMode() {
            const spreadsheetId = document.getElementById('spreadsheet').value;
            if (!spreadsheetId) {
                showAlert('Por favor, selecione uma planilha primeiro.', 'error');
                return;
            }
            const modal = document.getElementById('editor-modal');
            const houseList = document.getElementById('modal-house-list');
            houseList.innerHTML = '<li>Carregando...</li>';
            modal.style.display = 'block';

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.ok) {
                        houseList.innerHTML = '';
                        if (result.payload.length === 0) {
                            houseList.innerHTML = '<li>Nenhum HOUSE encontrado.</li>';
                            return;
                        }
                        result.payload.forEach(house => {
                            const li = document.createElement('li');
                            li.textContent = house;
                            li.className = 'house-list-item';
                            li.onclick = () => selectHouseForEditing(house);
                            houseList.appendChild(li);
                        });
                    } else {
                        showAlert('Erro ao buscar HOUSEs: ' + result.message, 'error');
                        houseList.innerHTML = '<li>Erro ao carregar.</li>';
                    }
                })
                .withFailureHandler(function(error) {
                    showAlert('Erro ao buscar HOUSEs: ' + error.message, 'error');
                    houseList.innerHTML = '<li>Erro ao carregar.</li>';
                })
                .getHousesFromSpreadsheet(spreadsheetId);
        }

        function closeEditorModal() {
            document.getElementById('editor-modal').style.display = 'none';
        }

        function filterHouses() {
            const input = document.getElementById('house-search');
            const filter = input.value.toUpperCase();
            const ul = document.getElementById('modal-house-list');
            const li = ul.getElementsByTagName('li');

            for (let i = 0; i < li.length; i++) {
                const txtValue = li[i].textContent || li[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = '';
                } else {
                    li[i].style.display = 'none';
                }
            }
        }

        function selectHouseForEditing(house) {
            const spreadsheetId = document.getElementById('spreadsheet').value;
            showAlert('Carregando dados para o HOUSE: ' + house, 'success');
            closeEditorModal();

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.ok) {
                        const data = result.payload;

                        // Limpa o formulário antes de preencher
                        resetForm();

                        document.getElementById('mawb').value = data.mawb;

                        // Adiciona o HOUSE à lista e ao estado
                        isEditMode = true; // Ativa o modo de edição
                        const newId = houseIdCounter++;
                        houses = [{ id: newId, name: data.house }];
                        houseData[newId] = data;
                        updateHousesDisplay();
                        selectHouse(newId);

                        showAlert('Dados carregados. Você pode agora editar e salvar as informações.', 'success');
                    } else {
                        showAlert(`Erro ao carregar dados do HOUSE: ${result.message} - Detalhes: ${result.detail}`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showAlert(`Erro fatal ao carregar dados do HOUSE: ${error.message}`, 'error');
                })
                .getDataForHouse(spreadsheetId, house);
        }

        // Funções do Modal de Serviços
        document.getElementById('servicosToggle').addEventListener('change', function(event) {
            if (event.target.checked) {
                openServicosModal();
            } else {
                // Aqui você pode adicionar lógica para reverter o estado, se necessário
            }
        });

        function openServicosModal() {
            const spreadsheetId = document.getElementById('spreadsheet').value;
            if (!spreadsheetId) {
                showAlert('Por favor, selecione uma planilha primeiro.', 'error');
                document.getElementById('servicosToggle').checked = false;
                return;
            }
            const modal = document.getElementById('servicos-modal');
            const houseList = document.getElementById('servicos-modal-house-list');
            houseList.innerHTML = '<li>Carregando...</li>';
            modal.style.display = 'block';

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.ok) {
                        houseList.innerHTML = '';
                        if (result.payload.length === 0) {
                            houseList.innerHTML = '<li>Nenhum HOUSE encontrado.</li>';
                            return;
                        }
                        result.payload.forEach(house => {
                            const li = document.createElement('li');
                            li.textContent = house;
                            li.className = 'house-list-item';
                            li.onclick = () => selectHouseForServicos(house);
                            houseList.appendChild(li);
                        });
                    } else {
                        showAlert('Erro ao buscar HOUSEs: ' + result.message, 'error');
                        houseList.innerHTML = '<li>Erro ao carregar.</li>';
                    }
                })
                .withFailureHandler(function(error) {
                    showAlert('Erro ao buscar HOUSEs: ' + error.message, 'error');
                    houseList.innerHTML = '<li>Erro ao carregar.</li>';
                })
                .getAllHouses();
        }

        function closeServicosModal() {
            document.getElementById('servicos-modal').style.display = 'none';
            document.getElementById('servicosToggle').checked = false;
        }

        function filterServicosHouses() {
            const input = document.getElementById('servicos-house-search');
            const filter = input.value.toUpperCase();
            const ul = document.getElementById('servicos-modal-house-list');
            const li = ul.getElementsByTagName('li');

            for (let i = 0; i < li.length; i++) {
                const txtValue = li[i].textContent || li[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = '';
                } else {
                    li[i].style.display = 'none';
                }
            }
        }

        function selectHouseForServicos(house) {
            const spreadsheetId = document.getElementById('spreadsheet').value;
            showAlert('Carregando dados para o HOUSE: ' + house, 'success');
            closeServicosModal();

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.ok) {
                        const data = result.payload;

                        if (!isServicosMode) {
                            // First time selecting a HOUSE in Serviços mode
                            resetForm();
                            document.getElementById('mawb').value = data.mawb;
                            isServicosMode = true;
                        }

                        // Create a new entry with a unique ID but the original name
                        const newId = houseIdCounter++;
                        const newHouse = { id: newId, name: data.house };
                        houses.push(newHouse);
                        houseData[newId] = JSON.parse(JSON.stringify(data)); // Deep copy

                        // Clear the 'responsaveis' field for the new entry
                        houseData[newId].responsaveis = [];

                        updateHousesDisplay();
                        selectHouse(newId);

                        showAlert('Dados carregados. Adicione um novo responsável e salve.', 'success');
                    } else {
                        showAlert(`Erro ao carregar dados do HOUSE: ${result.message} - Detalhes: ${result.detail}`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showAlert(`Erro fatal ao carregar dados do HOUSE: ${error.message}`, 'error');
                })
                .getDataForHouse(spreadsheetId, house);
        }
</script>